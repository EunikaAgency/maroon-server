const WPFormsGeolocationMapboxAPI=window.WPFormsGeolocationMapboxAPI||function(a,s){const n=[],i={getFirstFeature:function(e){return e&&Object.prototype.hasOwnProperty.call(e,"features")&&e.features.length?e.features.shift():null},getFeatureProperties:function(e){return Object.prototype.hasOwnProperty.call(e,"properties")?e.properties:null},getFeatureProperty:function(e,t){e=i.getFeatureProperties(e);return Object.prototype.hasOwnProperty.call(e,t)?["region_code","country_code"].includes(t)?e[t].toUpperCase():e[t]:""},getFeatureCoordinates:function(e){return Object.prototype.hasOwnProperty.call(e,"geometry")&&Object.prototype.hasOwnProperty.call(e.geometry,"coordinates")?{lng:e.geometry.coordinates[0],lat:e.geometry.coordinates[1]}:wpforms_geolocation_settings.default_location},prepareProperties:function(e){const o={};return e.context.forEach(function(e){var t=e.id.split(".")[0];o[t]=e.text,Object.prototype.hasOwnProperty.call(e,"short_code")&&(o[t+"_code"]=e.short_code.replace(/^US-/,""))}),Object.prototype.hasOwnProperty.call(e,"text")&&(o.address_line1=e.text),Object.prototype.hasOwnProperty.call(e,"address")&&(o.address_line1+=" "+e.address),Object.prototype.hasOwnProperty.call(e,"place_name")&&(o.place_name=e.place_name),o}},o={receivePlace:function(e,t){const o=new XMLHttpRequest,a=new URL(`https://api.mapbox.com/geocoding/v5/mapbox.places/${e.lng},${e.lat}.json`);a.searchParams.set("access_token",wpforms_geolocation_settings.autocompleteSettings.common.access_token),a.searchParams.set("limit","1"),a.searchParams.set("type","address"),o.onreadystatechange=function(){var e;4===o.readyState&&200===o.status&&(e=JSON.parse(o.responseText),e=i.getFirstFeature(e))&&(e.properties=i.prepareProperties(e),t(e))},o.open("GET",a.toString()),o.send()}},r={getStateCoordinates:function(e,t){return e.settings.autocompleteSettings.strict&&(e=e.settings.autocompleteSettings.strict.toString().toLowerCase(),Object.prototype.hasOwnProperty.call(wpforms_geolocation_settings.states,e))&&Object.prototype.hasOwnProperty.call(wpforms_geolocation_settings.states[e],t)?wpforms_geolocation_settings.states[e][t]:null}},l={init(){"loading"===a.readyState?s.addEventListener("load",l.ready):l.ready()},ready(){l.getFields(),n.length&&(l.events(),l.initFieldPlaceMaps(),l.detectGeolocation())},events(){a.onwpformsProcessConditionalsField=function(e,t,o){t=a.getElementById("wpforms-"+t+"-field_"+o);t&&t.hasAttribute("data-autocomplete")&&s.dispatchEvent(new Event("resize"))},a.onwpformsRepeaterFieldCloneCreated=function(){l.getFields(),l.initFieldPlaceMaps(),l.detectGeolocation()}},initFieldPlaceMaps(){n.forEach(function(e){l.initMap(e),l.initAutocomplete(e)})},showDebugMessage:function(e){s.location.hash&&"#wpformsdebug"===s.location.hash&&console.log(e)},getFields(){Array.prototype.slice.call(a.querySelectorAll('.wpforms-form .wpforms-field input[type="text"][data-autocomplete="1"]')).forEach(function(e){var t=e.closest(".wpforms-field"),o=e.hasAttribute("data-display-map")?t.querySelector(".wpforms-geolocation-map"):null,a=t.classList[1]?t.classList[1].replace("wpforms-field-",""):"text";let s={};"address"===a&&(s={address_line1:t.querySelector(".wpforms-field-address-address1"),address_line2:t.querySelector(".wpforms-field-address-address2"),place:t.querySelector(".wpforms-field-address-city"),postcode:t.querySelector(".wpforms-field-address-postal"),country_code:t.querySelector(".wpforms-field-address-country")},"SELECT"===(t=t.querySelector(".wpforms-field-address-state")).tagName?s.region_code=t:s.region=t),n.push({searchField:e,mapField:o,type:a,additionalFields:s,settings:l.getFieldSettings(e)})})},getFieldSettings:function(e){e=e.getAttribute("id").replaceAll("-","_");return{autocompleteSettings:l.getFieldAutocompleteSettings(e),mapSettings:l.getFieldMapSettings(e),markerSettings:l.getFieldMarkerSettings(e)}},getFieldAutocompleteSettings:function(e){return Object.assign({},wpforms_geolocation_settings.autocompleteSettings.common||{},wpforms_geolocation_settings.autocompleteSettings[e]||{})},getFieldMapSettings:function(e){return Object.assign({trackResize:!0},wpforms_geolocation_settings.mapSettings.common||{},wpforms_geolocation_settings.mapSettings[e]||{})},getFieldMarkerSettings:function(e){return Object.assign({draggable:!0},wpforms_geolocation_settings.markerSettings.common||{},wpforms_geolocation_settings.markerSettings[e]||{})},initMap(t){var e,o,a;!t.mapField||t.mapField.classList.contains("mapboxgl-map")||(e=t.mapField.closest(".elementor-location-popup"))&&!e.offsetParent||(mapboxgl.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token,t.map=new mapboxgl.Map(Object.assign({container:t.mapField},t.settings.mapSettings)),t.map.addControl(new mapboxgl.NavigationControl),t.marker=new mapboxgl.Marker(t.settings.markerSettings).setLngLat([t.settings.mapSettings.center.lng,t.settings.mapSettings.center.lat]).addTo(t.map),t.marker.on("dragend",l.markerChanged),e=new MutationObserver(function(e){e.forEach(function(){t.map.resize()})}),a=(o=t.mapField).closest(".wpforms-page"),e.observe(o.parentElement,{attributes:!0,attributeFilter:["style"]}),a&&e.observe(a,{attributes:!0,attributeFilter:["style"]}))},updateMap:function(e,t){e.map&&e.marker&&(t=i.getFeatureCoordinates(t),e.marker.setLngLat([t.lng,t.lat]),e.map.setCenter([t.lng,t.lat]))},markerChanged:function(){const t=l.findFieldPlaceBy("map",this._map);t&&o.receivePlace(this.getLngLat(),function(e){l.updateMap(t,e),l.updateFields(t,e)})},findFieldPlaceBy:function(t,o){let a=null;return n.some(function(e){if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]===o||e.additionalFields&&Object.prototype.hasOwnProperty.call(e.additionalFields,t)&&e.additionalFields[t]===o)return a=e,!0}),a},initAutocomplete(e){mapboxsearch.config.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token;var t=a.createElement("mapbox-address-autofill");t.append(e.searchField.cloneNode(!0)),e.searchField.replaceWith(t),t.accessToken=wpforms_geolocation_settings.autocompleteSettings.common.access_token,t.options=e.settings.autocompleteSettings,t.theme={cssText:`
					.Results {
						z-index: 10000;
					}
				`},e.autocomplete=t,e.searchField=t.querySelector("input"),e.autocomplete.addEventListener("retrieve",l.updateFieldPlace),e.autocomplete.addEventListener("keydown",l.preventSubmitOnPressEnter),"address"===e.type&&(e.additionalFields.address_line1=e.searchField,l.bindAddressFieldEvents(e))},bindAddressFieldEvents:function(e){var t;e.additionalFields.country_code&&e.additionalFields.country_code.addEventListener("change",l.updateCountry),e.settings.autocompleteSettings.strict&&(t=Array.isArray(e.settings.autocompleteSettings.strict)?e.settings.autocompleteSettings.strict[0]:e.settings.autocompleteSettings.strict,e.settings.autocompleteSettings.strict=t,e.autocomplete.options.country=t?t.toString().toUpperCase():"",e.additionalFields.region_code.addEventListener("change",l.updateArea))},updateFieldPlace:function(e){var t=l.findFieldPlaceBy("autocomplete",e.target);t&&(e=i.getFirstFeature(e.detail),l.updateFields(t,e),l.updateMap(t,e))},preventSubmitOnPressEnter:function(e){13===e.keyCode&&e.target.ariaExpanded&&e.stopPropagation()},updateFields:function(e,t){"text"===e.type?l.updateTextField(e,t):"address"===e.type&&l.updateAddressField(e,t),l.showDebugMessage("Fields was updated"),l.showDebugMessage(e),l.showDebugMessage(t)},updateTextField:function(e,t){e.searchField.value=i.getFeatureProperty(t,"place_name"),l.triggerEvent(e.searchField,"change")},updateAddressField:function(e,t){l.clearAdditionalFields(e);for(var[o,a]of Object.entries(e.additionalFields))a&&(o=i.getFeatureProperty(t,o))&&(l.isConversationalSelect(a)?l.updateConversationalSelect(a,o):(a.value=o,l.triggerEvent(a,"change")))},isConversationalSelect:function(e){return"SELECT"===e.tagName&&Boolean(e.closest(".wpforms-conversational-select"))},updateConversationalSelect:function(e,t){var o=e.closest(".wpforms-conversational-select"),a=e.querySelector('option[value="'+t+'"]'),o=o.querySelector(".wpforms-conversational-form-dropdown-input input");e.value=t,a&&o&&(o.value=a.innerText)},triggerEvent:function(e,t){t=new Event(t,{bubbles:!0,cancelable:!0});e.dispatchEvent(t)},clearAdditionalFields:function(e){e.additionalFields&&Object.values(e.additionalFields).forEach(function(e){e&&(e.value="")})},updateCountry:function(){var e=l.findFieldPlaceBy("country_code",this),t=this.value.toString().toUpperCase();e&&e.autocomplete&&(e.autocomplete.options.country=t,l.showDebugMessage("Autocomplete field restrict to country: "+t))},updateArea:function(){var e=l.findFieldPlaceBy("region_code",this),t=this.value.toString().toUpperCase(),o=r.getStateCoordinates(e,t);l.showDebugMessage("Autocomplete field try to find the "+t+" state"),e&&t&&o||l.showDebugMessage("Autocomplete field doesn't restrict to the "+t+" state"),e.autocomplete.options.proximity=o,l.showDebugMessage("Autocomplete field restrict to the "+t+" state")},detectGeolocation(){wpforms_geolocation_settings.current_location&&navigator.geolocation&&n&&navigator.geolocation.getCurrentPosition(function(e){e={lat:e.coords.latitude.toFixed(6),lng:e.coords.longitude.toFixed(6)};o.receivePlace(e,function(a){n.forEach(function(e,t){var o;e.currentGeolocationInited||(o=e.searchField.closest(".wpforms-field"))&&o.classList.contains("wpforms-conditional-hide")||(l.updateMap(e,a),l.updateFields(e,a),n[t].currentGeolocationInited=!0)})})})}};return l}(document,window);WPFormsGeolocationMapboxAPI.init(),window.addEventListener("elementor/popup/show",WPFormsGeolocationMapboxAPI.init);